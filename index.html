<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electronic Lab Notebook</title>
    <!-- Tailwind CSSを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <! -- Mermaid.jpライブラリの読み込み>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        /* Sidebar item styles */
        .sidebar-item {
            transition: background-color 0.2s ease-in-out;
        }
        .sidebar-item:hover {
            background-color: #4A5568; /* hover:bg-gray-600 */
        }
        .sidebar-item.active {
            background-color: #4299E1; /* bg-blue-500 */
        }

        /* Mercaid.jpのダークテーマ用カスタムスタイル*/
        .mermaid .node rect, .mermaid .node circle, .mermaid .node polygon{
            fill: #2D3748; /* bg-gray-700 */
            stroke: #4A5568; /* border-gray-600*/
            stroke-width: 2px;
        }
        .mermaid .node .label { color: #E2E8F0; } /* text-gray-200 */
        .mermaid .edgeLabel { background-color: #1A202C; color: #A0AEC0; } /* bg-gray-800, text-gray-400 */
        .mermaid .edgePath { stroke: #4A5568; }
        .mermaid .arrowhead { fill: #4A5568; }

        /* ノードのカテゴリに応じた色分けスタイル */
        .mermaid .node.substances rect { fill: #2B6CB0; } /* bg-blue-700 */
        .mermaid .node.processing rect { fill: #9B2C2C; } /* bg-red-700 */
        .mermaid .node.measurement rect { fill: #2C7A7B; } /* bg-teal-700 */
        .mermaid .node.others rect { fill: #4A5568; } /* bg-gray-600 */        
    </style>
</head>
<body class="bg-gray-800 text-gray-200 font-sans">

    <div class="container mx-auto p-4">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-white">Electronic Lab Notebook</h1>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-4 gap-6">
            
            <!-- 左カラム: プロジェクトとフォルダ (今回は静的) -->
            <aside class="md:col-span-1 bg-gray-900 p-4 rounded-lg">
                <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Projects</h2>
                <div id="project-list">
                    <!-- 今はプロジェクト名を固定で表示 -->
                    <div class="p-2 rounded cursor-pointer bg-gray-700">PJ-Verification-Test</div>
                    <div class="pl-4 mt-2">
                        <div class="p-2 rounded cursor-pointer bg-gray-600">Team_Alpha</div>
                         <div class="pl-4 mt-2">
                            <div class="p-2 rounded cursor-pointer bg-blue-600 text-white">Polymer_Synthesis</div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- 中央カラム: 実験ノート一覧 -->
            <section class="md:col-span-1 bg-gray-900 p-4 rounded-lg">
                <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Experiments</h2>
                <div id="experiment-list" class="space-y-2">
                    <!-- JavaScriptによって実験ノートの一覧がここに挿入されます -->
                    <p id="exp-loading">Loading experiments...</p>
                </div>
            </section>

            <!-- 右カラム: 詳細表示 -->
            <section id="details-panel" class="md:col-span-2 bg-gray-900 p-4 rounded-lg">
                <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Details</h2>
                <div id="details-content">
                    <p class="text-gray-400">Select an experiment to see details.</p>
                </div>
            </section>

        </main>
    </div>

    <script>
        // Mercail.jsの初期化（ページ読み込み時の自動実行はオフにする）
        mermaid.initialize({ startOnLoad: false, theme: 'base' });

        const API_BASE_URL = "http://127.0.0.1:8000";

        // DOM要素を取得
        const expListElement = document.getElementById('experiment-list');
        const expLoadingElement = document.getElementById('exp-loading');
        const detailsContentElement = document.getElementById('details-content');

        /**
         * 指定されたプロジェクトとフォルダパスの実験ノート一覧を取得して表示する関数
         */
        async function fetchAndDisplayExperiments(projectName, folderPath) {
            try {
                const response = await fetch(`${API_BASE_URL}/experiments/?project_name=${projectName}&folder_path=${folderPath}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const experiments = await response.json();

                // ローディング表示を消去
                expLoadingElement.style.display = 'none';
                expListElement.innerHTML = ''; // 既存のリストをクリア

                if (experiments.length === 0) {
                    expListElement.innerHTML = '<p class="text-gray-400">No experiments found.</p>';
                    return;
                }

                // 取得した実験ノートをリストとして表示
                experiments.forEach(exp => {
                    const item = document.createElement('div');
                    item.className = 'sidebar-item p-3 rounded-md cursor-pointer text-sm';
                    item.textContent = exp.name;
                    item.dataset.expId = exp.id; // クリック時に使うIDをdata属性に保存
                    
                    // クリックイベントを追加
                    item.addEventListener('click', () => {
                        // 他のアイテムのアクティブ状態を解除
                        document.querySelectorAll('#experiment-list .sidebar-item').forEach(el => el.classList.remove('active'));
                        // クリックされたアイテムをアクティブに
                        item.classList.add('active');
                        // 詳細表示関数を呼び出し
                        fetchAndDisplayDetails(exp.id);
                    });

                    expListElement.appendChild(item);
                });

            } catch (error) {
                console.error('Failed to fetch experiments:', error);
                expLoadingElement.textContent = 'Failed to load experiments.';
            }
        }

        /**
         * 指定された実験ノートIDの詳細を取得し、フローチャートを描画する関数
         */
        async function fetchAndDisplayDetails(expId) {
            detailsContentElement.innerHTML = '<p class="text-gray-400">Loading flowchart...</p>';
            try {
                const response = await fetch(`${API_BASE_URL}/note/${expId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const details = await response.json();
                
                // ステップ1: Mermaid.jsが理解できるテキスト構文を生成する
                let mermaidSyntax = 'graph TD;\n'; // Top-Down (上から下へ) のグラフ

                // ノードの定義 (例: node_id["表示テキスト"])
                details.nodes.forEach(node => {
                    // ノード名に " や ' が含まれると構文エラーになるため、サニタイズ（無害化）する
                    const nodeName = (node.properties.node_name || 'Unnamed Node')
                        .replace(/"/g, '#quot;')
                        .replace(/'/g, '#apos;');
                    mermaidSyntax += `    ${node.id}["${nodeName}"];\n`;
                    mermaidSyntax += `    class ${node.id} ${node.category.toLowerCase()};\n`;
                });

                // エッジ（繋がり）の定義 (例: source_id -->|"ラベル"| target_id)
                details.edges.forEach(edge => {
                    // edge.label (以前はedge.type) が存在しない場合は空文字を使う
                    const edgeLabel = (edge.label || '')
                        .replace(/"/g, '#quot;')
                        .replace(/'/g, '#apos;');
                    mermaidSyntax += `    ${edge.source_id} -->|"${edgeLabel}"| ${edge.target_id};\n`;
                });
                
                // ステップ2: 生成した構文をHTMLに挿入
                detailsContentElement.innerHTML = `
                    <h3 class="text-lg font-bold text-blue-400">${details.experiment_name}</h3>
                    <p class="text-sm text-gray-400">Registrant: ${details.registrant} | Date: ${details.registration_date}</p>
                    <div class="mermaid mt-4">
                        ${mermaidSyntax}
                    </div>
                `;

                // ステップ3: Mermaid.jsに描画を命令
                await mermaid.run();

            } catch (error) {
                console.error('Failed to fetch details:', error);
                detailsContentElement.innerHTML = '<p class="text-red-500">Failed to load flowchart details.</p>';
            }
        }

        // ページ読み込み完了時に、検証用プロジェクトの実験ノート一覧を自動的に取得
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndDisplayExperiments('PJ-Verification-Test', '/Team_Alpha/Polymer_Synthesis/');
        });
    </script>

</body>
</html>

